<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å¤ç¥­ã‚Šãƒã‚±ãƒƒãƒˆç®¡ç†App</title>

<!-- âœ… QRã‚³ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Noto Sans JP", sans-serif;
    background: #fff8e1;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem;
  }
  h1 {
    color: #6d4c41;
    margin-bottom: 0.5rem;
  }
  #qr-reader {
    width: min(480px, 90vw);
    height: auto;
    border: 2px solid #6d4c41;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
  }
  #status {
    margin-top: 0.5rem;
    font-size: 0.9rem;
  }
  #ticket-section {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    width: min(400px, 90vw);
  }
  .ticket-btn {
    display: block;
    width: 100%;
    margin: 6px 0;
    padding: 14px;
    border-radius: 8px;
    border: none;
    background: #ff7043;
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
  }
  .ticket-btn:disabled {
    background: #ccc;
  }
</style>
</head>
<body>

<h1>ğŸ† å¤ç¥­ã‚Šãƒã‚±ãƒƒãƒˆç®¡ç†</h1>

<div id="qr-reader"></div>
<p id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­ã§ã™...</p>

<div id="ticket-section">
  <p>å‚åŠ è€…ID: <span id="participantId"></span></p>
  <button class="ticket-btn" data-type="å°„çš„ãƒ»è¼ªæŠ•ã’">å°„çš„ãƒ»è¼ªæŠ•ã’åˆ¸ã‚’ä½¿ç”¨</button>
  <button class="ticket-btn" data-type="ç„¼ããã°">ç„¼ããã°åˆ¸ã‚’ä½¿ç”¨</button>
  <button class="ticket-btn" data-type="ãƒ©ãƒ ãƒ">ãƒ©ãƒ ãƒåˆ¸ã‚’ä½¿ç”¨</button>
  <button class="ticket-btn" data-type="ã‚¢ã‚¤ã‚¹ãƒãƒ¼">ã‚¢ã‚¤ã‚¹ãƒãƒ¼åˆ¸ã‚’ä½¿ç”¨</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbXXXXXXXXXXXX/exec"; // â†Apps Scriptãƒ‡ãƒ—ãƒ­ã‚¤URL

let html5QrCode;
let currentParticipantId = null;

function setStatus(msg, error=false){
  const s = document.getElementById("status");
  s.textContent = msg;
  s.style.color = error ? "red" : "#555";
}

function onScanSuccess(decodedText) {
  // âœ… ä¸€åº¦èª­ã¿å–ã£ãŸã‚‰åœæ­¢
  html5QrCode.stop().then(() => {
    setStatus("QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸï¼");
    document.getElementById("participantId").textContent = decodedText;
    document.getElementById("ticket-section").style.display = "block";
    currentParticipantId = decodedText;
  });
}

async function initCamera() {
  try {
    const devices = await Html5Qrcode.getCameras();
    if (devices.length === 0) {
      setStatus("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", true);
      return;
    }

    const backCam = devices.find(d => /back|rear|ç’°å¢ƒ/i.test(d.label)) || devices[0];
    html5QrCode = new Html5Qrcode("qr-reader");

    await html5QrCode.start(
      backCam.id,
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      (err) => {} // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç„¡è¦–ï¼‰
    );

    setStatus("QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„");
  } catch (e) {
    console.error(e);
    setStatus("ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + e.message, true);
  }
}

window.addEventListener("load", () => {
  initCamera(); // âœ… ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«åˆæœŸåŒ–
});

// ============================
// ãƒã‚±ãƒƒãƒˆä½¿ç”¨APIå‘¼ã³å‡ºã—å‡¦ç†
// ============================
document.querySelectorAll(".ticket-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!currentParticipantId) {
      alert("QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚");
      return;
    }

    const type = btn.dataset.type;
    btn.disabled = true;
    setStatus(`${type}åˆ¸ã‚’å‡¦ç†ä¸­...`);

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "use_ticket",
          id: currentParticipantId,
          ticketType: type,
          timestamp: new Date().toISOString()
        })
      });

      const data = await res.json();
      if (data.success) {
        setStatus(`âœ… ${type}åˆ¸ã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼ï¼ˆæ®‹ã‚Š: ${data.remaining ?? "N/A"}ï¼‰`);
      } else {
        setStatus(`âš ï¸ ${data.message || "ä½¿ç”¨ã§ãã¾ã›ã‚“"}`, true);
      }
    } catch (e) {
      console.error(e);
      setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", true);
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
</body>
</html>
